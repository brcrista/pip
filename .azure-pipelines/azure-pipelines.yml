stages:
- stage: unit_test_1
  displayName: Unit test group 1
  jobs:
  - job:
    strategy:
      matrix:
        Linux-Python27:
          python.version: '2.7'
          vmImage: ubuntu-latest
        Linux-Python37:
          python.version: '3.7'
          vmImage: ubuntu-latest
        Windows-Python27:
          python.version: '2.7'
          vmImage: windows-latest
        Windows-Python37:
          python.version: '3.7'
          vmImage: windows-latest
        MacOS-Python27:
          python.version: '2.7'
          vmImage: macos-latest
        MacOS-Python37:
          python.version: '3.7'
          vmImage: macos-latest
    pool:
      vmImage: $[ variables.vmImage ]
    steps:
    - template: steps/unit-tests.yml

- stage: unit_test_2
  displayName: Unit test group 2
  jobs:
  - job:
    strategy:
      matrix:
        Linux-Python34:
          python.version: '3.4'
          vmImage: ubuntu-latest
        Linux-Python35:
          python.version: '3.5'
          vmImage: ubuntu-latest
        Linux-Python36:
          python.version: '3.6'
          vmImage: ubuntu-latest
        Windows-Python34:
          python.version: '3.4'
          vmImage: windows-latest
        Windows-Python35:
          python.version: '3.5'
          vmImage: windows-latest
        Windows-Python36:
          python.version: '3.6'
          vmImage: windows-latest
        MacOS-Python34:
          python.version: '3.4'
          vmImage: macos-latest
        MacOS-Python35:
          python.version: '3.5'
          vmImage: macos-latest
        MacOS-Python36:
          python.version: '3.6'
          vmImage: macos-latest
    pool:
      vmImage: $[ variables.vmImage ]
    steps:
    - template: steps/unit-tests.yml

- stage: integration_test
  displayName: Integration test
  jobs:
  - job:
    strategy:
      matrix:
        Linux-Python27:
          python.version: '2.7'
          vmImage: ubuntu-latest
        Linux-Python37:
          python.version: '3.7'
          vmImage: ubuntu-latest
        MacOS-Python27:
          python.version: '2.7'
          vmImage: macos-latest
        MacOS-Python37:
          python.version: '3.7'
          vmImage: macos-latest
    pool:
      vmImage: $[ variables.vmImage ]
    steps:
    - template: steps/integration-tests.yml

  - job:
    strategy:
      matrix:
        Windows-Python27:
          python.version: '2.7'
          vmImage: windows-latest
        Windows-Python37:
          python.version: '3.7'
          vmImage: windows-latest
    pool:
      vmImage: $[ variables.vmImage ]
    steps:
    - template: steps/integration-tests-windows.yml

- stage: package
  displayName: Package
  jobs:
  - job:
    strategy:
      matrix:
        Linux:
          vmImage: ubuntu-latest
        Windows:
          vmImage: windows-latest
        MacOS:
          vmImage: macos-latest
    pool:
      vmImage: $[ variables.vmImage ]
    steps:
    - template: steps/package.yml
